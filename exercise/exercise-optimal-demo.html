

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Exercise 5 (demo) - Optimal interpolation &#8212; seaocn</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'exercise/exercise-optimal-demo';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Exercise 6 - CTD Alignment" href="exercise-ctd-align.html" />
    <link rel="prev" title="Exercise 4 - Slopes &amp; Integrals" href="exercise-geostrophy.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="seaocn - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="seaocn - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    MSc Seagoing Oceanography
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../overview/catalog-listing.html">Course catalog listing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/syllabus.html">Syllabus (SuSe24)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/schedule.html">Schedule (SuSe24)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../topics/course_overview.html">1. Course overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/scientific_basis.html">2. Scientific basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/instruments_platforms.html">3. Instruments and platforms (<em>change week</em>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/equations_v_data.html">4. Equations v data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/amoc_methods.html">5. AMOC Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/experiment_design.html">6. Experiment design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/sensors.html">7. Sensors</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exercises</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="exercise-git.html">Exercise 0a - Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-python.html">Exercise 0b - Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-cnv.html">Exercise 1 - Profile data</a></li>



<li class="toctree-l1"><a class="reference internal" href="exercise-tseries.html">Exercise 2a  Time series</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-filter.html">Exercise 2b  Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-map.html">Exercise 3 - Exploring map projections</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-geostrophy.html">Exercise 4 -  Slopes &amp; Integrals</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Exercise 5 (demo) - Optimal interpolation</a></li>

<li class="toctree-l1"><a class="reference internal" href="exercise-ctd-align.html">Exercise 6 - CTD Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise-glider-demo.html">Exercise 7 (demo) - Gliders in the Baltic</a></li>


</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Assignments</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../assignment/assignment-1.html">Assignments</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../resource/books.html">Books + Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resource/git.html">Git for sharing &amp; versioning</a></li>

<li class="toctree-l1"><a class="reference internal" href="../resource/python.html">Python</a></li>

<li class="toctree-l1"><a class="reference internal" href="../resource/glossary.html">Glossary</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../build-the-book/getting-started.html">Setting up a jupyter book</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../build-the-book/jupyter-book.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build-the-book/github-pages.html">Prepare the git repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build-the-book/use-of-tokens.html">Use of tokens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build-the-book/regenerating-book.html">Regenerating the book after changes</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ifmeo-hamburg/seaocn" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ifmeo-hamburg/seaocn/issues/new?title=Issue%20on%20page%20%2Fexercise/exercise-optimal-demo.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/exercise/exercise-optimal-demo.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Exercise 5 (demo) - Optimal interpolation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Exercise 5 (demo) - Optimal interpolation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data">Explore the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-notebook">Create a notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-matlab-data">Load Matlab data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-data-to-xarray">Convert data to <code class="docutils literal notranslate"><span class="pre">xarray</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-missingdimensionserror">Error: <code class="docutils literal notranslate"><span class="pre">MissingDimensionsError</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-data-locations">Plot data locations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1-data-locations">Fig 1. Data locations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-2-clip-to-a-region-and-plot">Fig 2. Clip to a region and plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-mean-any-obvious-latitudinal-dependence">Remove mean &amp; any obvious latitudinal dependence</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-3-compute-latitudinal-temperature-dependence">Fig 3. Compute latitudinal temperature dependence</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-plot-the-process-of-fitting-a-line">Now plot the process of fitting a line</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-remove-outliers-larger-than-3-standard-deviations">(Optional) Remove outliers larger than 3 standard deviations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-the-covariance-function">Computing the covariance function</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-pairwise-differences">Calculate pairwise differences</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-new-xarray-to-hold-the-results">Create a new <code class="docutils literal notranslate"><span class="pre">xarray</span></code> to hold the results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-the-structure-function">Calculating the structure function</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bin-the-structure-function-as-a-function-of-distance">Bin the structure function as a function of distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-noise-and-variance">Estimate noise and variance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-covariance-function">Fit a covariance function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Bin the structure function as a function of distance</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-interpolation">Optimal interpolation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deriving-the-objective-estimate">Deriving the objective estimate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-error-estimate">The error estimate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-the-mean-and-periodic-signals">Removing the mean and periodic signals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-the-optimal-interpolation">Run the optimal interpolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-4-plot-the-mapped-data">Fig 4. Plot the mapped data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-5-add-back-in-your-mean-and-latitudinal-dependence-plot">Fig 5. Add back in your mean and latitudinal dependence + plot</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="exercise-5-demo-optimal-interpolation">
<h1>Exercise 5 (demo) - Optimal interpolation<a class="headerlink" href="#exercise-5-demo-optimal-interpolation" title="Permalink to this heading">#</a></h1>
<p><strong>Aim:</strong> To map temperature data based on individual Argo profile data into an x-y-t set of maps.</p>
<p><strong>Data:</strong> Data from early Argo profiles in the North Atlantic, provided in a <code class="docutils literal notranslate"><span class="pre">*.mat</span></code> file.</p>
<p><strong>Directions:</strong> Create an <code class="docutils literal notranslate"><span class="pre">*.ipynb</span></code> and figures of the mapped data.</p>
<p><strong>Demo:</strong> Since this is a more-involved calculation, most of the code has been provided for you below.  There are a few places where you need to make edits/tweaks and choices.  Some of these are indicated by the ellipses <code class="docutils literal notranslate"><span class="pre">...</span></code>.  Others simply say in the text <code class="docutils literal notranslate"><span class="pre">Try</span> <span class="pre">this</span></code>.</p>
<p><strong>This exercise is based on one from a course by <a class="reference external" href="http://staff.washington.edu/kellyapl/Research.html">Kathie Kelly</a> in 2008.</strong></p>
<hr>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>The method is introduced in: <span id="id1">Bretherton <em>et al.</em> [<a class="reference internal" href="../resource/books.html#id5" title="F. P. Bretherton, R. E. Davis, and C. B. Fandry. A technique for objective analysis and design of oceanographic experiments applied to MODE-73. Deep-Sea Res., 23:559–582, 1976.">1976</a>]</span> A technique for objective analysis and design of oceanographic experiments applied to MODE-73.</p>
</div>
<section id="explore-the-data">
<h2>Explore the data<a class="headerlink" href="#explore-the-data" title="Permalink to this heading">#</a></h2>
<section id="create-a-notebook">
<h3>Create a notebook<a class="headerlink" href="#create-a-notebook" title="Permalink to this heading">#</a></h3>
<ol class="arabic">
<li><p>Create an <code class="docutils literal notranslate"><span class="pre">*.ipynb</span></code> containing the commands for this assignment, or copy this file.</p>
<div class="admonition-file-naming-convention admonition">
<p class="admonition-title">File naming convention</p>
<p>Name your python notebook something useful <code class="docutils literal notranslate"><span class="pre">ex&lt;X&gt;-&lt;Lastname&gt;-&lt;slug&gt;-seaocn.ipynb</span></code> where you replace <code class="docutils literal notranslate"><span class="pre">&lt;X&gt;</span></code> with the exercise number and <code class="docutils literal notranslate"><span class="pre">&lt;slug&gt;</span></code> with the short slug to name the topic, and <code class="docutils literal notranslate"><span class="pre">&lt;Lastname&gt;</span></code> with your last name.</p>
<p>Figures should be named something like <code class="docutils literal notranslate"><span class="pre">ex&lt;X&gt;fig&lt;Y&gt;-&lt;Lastname&gt;-&lt;slug&gt;-seaocn.png</span></code> where you replace <code class="docutils literal notranslate"><span class="pre">&lt;X&gt;</span></code> with the exercise number, <code class="docutils literal notranslate"><span class="pre">&lt;Y&gt;</span></code> with the figure number, and <code class="docutils literal notranslate"><span class="pre">&lt;Lastname&gt;</span></code> with your last name.</p>
</div>
</li>
<li><p>Import necessary packages.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and <code class="docutils literal notranslate"><span class="pre">numpy</span></code> and <code class="docutils literal notranslate"><span class="pre">xarray</span></code>.  You may also need <code class="docutils literal notranslate"><span class="pre">scipy</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
<p>If you are missing any of these packages, please refer to <a class="reference internal" href="../resource/python.html"><span class="doc std std-doc">Resources: Python</span></a>.</p>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-matlab-data">
<h3>Load Matlab data<a class="headerlink" href="#load-matlab-data" title="Permalink to this heading">#</a></h3>
<ol class="arabic" start="3">
<li><p>Use the file <code class="docutils literal notranslate"><span class="pre">argo_med.mat</span></code> in the <code class="docutils literal notranslate"><span class="pre">data/</span></code> directory.  With the <code class="docutils literal notranslate"><span class="pre">scipy</span></code> package, you can load matlab-format data files into python.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Scipy io: <a class="reference external" href="https://docs.scipy.org/doc/scipy/tutorial/io.html">https://docs.scipy.org/doc/scipy/tutorial/io.html</a></p>
</div>
</li>
<li><p>Load the file.  Here, we’re loading the matlab file into something called <code class="docutils literal notranslate"><span class="pre">mat_contents</span></code>.  Make a basic exploration. How big are the data?  What are the coordinates?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mat_contents</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mat_contents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Since the functions you have available depend on the type of the variable, don’t forget to use <code class="docutils literal notranslate"><span class="pre">type()</span></code> to find out what’s in there.</p>
<p>For consistency with the code below, use the names <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">pres0</span></code>, <code class="docutils literal notranslate"><span class="pre">latd</span></code>, <code class="docutils literal notranslate"><span class="pre">lond</span></code>, <code class="docutils literal notranslate"><span class="pre">tprof</span></code>.</p>
<p>Note that the time is in Matlab <code class="docutils literal notranslate"><span class="pre">datenum</span></code> format, which is days since 0000-01-01.  Check out some tips on how to convert between Matlab time and python datenum.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<ul>
<li><p>See <a class="reference external" href="https://stackoverflow.com/questions/13965740/converting-matlabs-datenum-format-to-python">https://stackoverflow.com/questions/13965740/converting-matlabs-datenum-format-to-python</a> which has the example we can adapt as</p>
<p>datenums = time.flatten()
timestamps = pd.to_datetime(datenums-719529, unit=’D’)</p>
</li>
</ul>
</div>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>

<span class="c1"># Change the path to match where you put the data</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;../data/&#39;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;argo_med.mat&#39;</span>
<span class="n">fname</span> <span class="o">=</span> <span class="n">file_path</span> <span class="o">+</span> <span class="n">filename</span>
<span class="n">mat_contents</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

<span class="c1"># Pull out the individual data fields</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">pres0</span> <span class="o">=</span> <span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;pres0&#39;</span><span class="p">]</span>
<span class="n">latd</span> <span class="o">=</span> <span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;latd&#39;</span><span class="p">]</span>
<span class="n">lond</span> <span class="o">=</span> <span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;lond&#39;</span><span class="p">]</span>
<span class="n">tprof</span> <span class="o">=</span> <span class="n">mat_contents</span><span class="p">[</span><span class="s1">&#39;tprof&#39;</span><span class="p">]</span>

<span class="c1"># Create a variable `timestamps` which is in Python datetime format.</span>
<span class="c1"># BUT, don&#39;t replace the `time` vector with this new one.  We will still use `time`</span>
<span class="n">datenums</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">timestamps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datenums</span><span class="o">-</span><span class="mi">719529</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verify that the time works.</span>
<span class="c1"># The code below should produce the output `18-Jan-2003`</span>
<span class="n">tstr</span> <span class="o">=</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%b-%Y&quot;</span><span class="p">)</span>
<span class="n">tstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;18-Jan-2003&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="convert-data-to-xarray">
<h3>Convert data to <code class="docutils literal notranslate"><span class="pre">xarray</span></code><a class="headerlink" href="#convert-data-to-xarray" title="Permalink to this heading">#</a></h3>
<p>We like <code class="docutils literal notranslate"><span class="pre">xarray</span></code> in this course, so we will re-bundle the data into an <code class="docutils literal notranslate"><span class="pre">xarray</span></code> object: a <code class="docutils literal notranslate"><span class="pre">DataSet</span></code>.  Below shows a way to do this which will throw an error.  Uncomment the lines and run it to see what the error looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#data_xr = xr.DataArray(data = tprof,</span>
<span class="c1">#                       coords={&#39;time&#39;: time, &#39;pres&#39;: pres0},</span>
<span class="c1">#                       dims = [&quot;time&quot;, &quot;pres&quot;])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="error-missingdimensionserror">
<h3>Error: <code class="docutils literal notranslate"><span class="pre">MissingDimensionsError</span></code><a class="headerlink" href="#error-missingdimensionserror" title="Permalink to this heading">#</a></h3>
<p>If you get an error like <code class="docutils literal notranslate"><span class="pre">MissingDimensionsError:</span> <span class="pre">cannot</span> <span class="pre">set</span> <span class="pre">variable</span> <span class="pre">'pres'</span> <span class="pre">with</span> <span class="pre">2-dimensional</span> <span class="pre">data</span> <span class="pre">without</span> <span class="pre">explicit</span> <span class="pre">dimension</span> <span class="pre">names.</span> <span class="pre">Pass</span> <span class="pre">a</span> <span class="pre">tuple</span> <span class="pre">of</span> <span class="pre">(dims,</span> <span class="pre">data)</span> <span class="pre">instead.</span></code>, this is a problem with the <code class="docutils literal notranslate"><span class="pre">shape</span></code> or size of your pressure or time dimensions.  Xarray wants these to be 1-dimensional.</p>
<p>Try a <code class="docutils literal notranslate"><span class="pre">np.shape(time)</span></code> to see how big it is.</p>
<p>If it is 1-dimensional, it will return something like
<code class="docutils literal notranslate"><span class="pre">(1019,)</span></code></p>
<p>If it is returning <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1019)</span></code>, this is 2-dimensional, and xarray is having trouble with it.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>We dealt with problems of dimensionality in <a class="reference internal" href="exercise-tseries.html"><span class="doc std std-doc">Ex-tseries</span></a>.  The solution there was a little magical function called <code class="docutils literal notranslate"><span class="pre">squeeze()</span></code> available in <code class="docutils literal notranslate"><span class="pre">xarray</span></code>.  Our variable here is a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array, but there also exists the function <code class="docutils literal notranslate"><span class="pre">numpy.squeeze()</span></code>.  So, squeeze your variables to remove extraneous dimensions.</p>
</div>
<p>After squeezing everything, create several <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> with the coordinates <code class="docutils literal notranslate"><span class="pre">time</span></code> and <code class="docutils literal notranslate"><span class="pre">pres</span></code>, where applicable.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_xr2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;latd&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">latd</span><span class="p">,</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">},</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Once you have done this for each of <code class="docutils literal notranslate"><span class="pre">tprof</span></code>, <code class="docutils literal notranslate"><span class="pre">latd</span></code>, <code class="docutils literal notranslate"><span class="pre">lond</span></code>, and <code class="docutils literal notranslate"><span class="pre">timestamps</span></code>, you can merge them into a single <code class="docutils literal notranslate"><span class="pre">xarray.DataSet</span></code> using:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>argo_med = xr.merge([data_xr,data_xr2,data_xr3,data_xr4])
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here.  </span>

<span class="c1"># Note that several of the below commands produce output, but youll only see the latest output print to the screen.</span>
<span class="c1"># If you want to see the output of the others, encase it with `print(...)`</span>
<span class="nb">type</span><span class="p">(</span><span class="n">tprof</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tprof</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">latd</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="c1"># Now squeeze</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">pres0</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">latd</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">lond</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pres0</span><span class="p">)</span>

<span class="c1"># Now create a data array for each of `tprof`, `latd`, `lond`, and `timestamps`.  Use the coordinate `time` and dimensions `time` and `pres0`.</span>
<span class="n">data_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tprof&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">tprof</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;pres&#39;</span><span class="p">:</span> <span class="n">pres0</span><span class="p">},</span>
                       <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;pres&quot;</span><span class="p">])</span>
<span class="n">data_xr2</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">data_xr3</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">data_xr4</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">argo_med</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_xr</span><span class="p">,</span><span class="n">data_xr2</span><span class="p">,</span><span class="n">data_xr3</span><span class="p">,</span><span class="n">data_xr4</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">argo_med</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">19</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pres0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="c1"># Now create a data array for each of `tprof`, `latd`, `lond`, and `timestamps`.  Use the coordinate `time` and dimensions `time` and `pres0`.</span>
<span class="ne">---&gt; </span><span class="mi">19</span> <span class="n">data_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tprof&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">tprof</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>                        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;pres&#39;</span><span class="p">:</span> <span class="n">pres0</span><span class="p">},</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>                        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;pres&quot;</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="n">data_xr2</span> <span class="o">=</span> <span class="o">...</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">data_xr3</span> <span class="o">=</span> <span class="o">...</span>

<span class="nn">File ~/micromamba/envs/seaocn_env/lib/python3.8/site-packages/xarray/core/dataarray.py:428,</span> in <span class="ni">DataArray.__init__</span><span class="nt">(self, data, coords, dims, name, attrs, indexes, fastpath)</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span> <span class="n">data</span> <span class="o">=</span> <span class="n">_check_data_shape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">427</span> <span class="n">data</span> <span class="o">=</span> <span class="n">as_compatible_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">428</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">_infer_coords_and_dims</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">fastpath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">_create_indexes_from_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

<span class="nn">File ~/micromamba/envs/seaocn_env/lib/python3.8/site-packages/xarray/core/dataarray.py:180,</span> in <span class="ni">_infer_coords_and_dims</span><span class="nt">(shape, coords, dims)</span>
<span class="g g-Whitespace">    </span><span class="mi">173</span>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">174</span>                 <span class="sa">f</span><span class="s2">&quot;conflicting sizes for dimension </span><span class="si">{</span><span class="n">d</span><span class="si">!r}</span><span class="s2">: &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">175</span>                 <span class="sa">f</span><span class="s2">&quot;length </span><span class="si">{</span><span class="n">sizes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="si">}</span><span class="s2"> on the data but length </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> on &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>                 <span class="sa">f</span><span class="s2">&quot;coordinate </span><span class="si">{</span><span class="n">k</span><span class="si">!r}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>             <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sizes</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">],):</span>
<span class="ne">--&gt; </span><span class="mi">180</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>             <span class="sa">f</span><span class="s2">&quot;coordinate </span><span class="si">{</span><span class="n">k</span><span class="si">!r}</span><span class="s2"> is a DataArray dimension, but &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span>             <span class="sa">f</span><span class="s2">&quot;it has shape </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="si">!r}</span><span class="s2"> rather than expected shape </span><span class="si">{</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>             <span class="s2">&quot;matching the dimension size&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="k">return</span> <span class="n">new_coords</span><span class="p">,</span> <span class="n">dims</span>

<span class="ne">ValueError</span>: coordinate &#39;pres&#39; is a DataArray dimension, but it has shape () rather than expected shape 6 matching the dimension size
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-data-locations">
<h3>Plot data locations<a class="headerlink" href="#plot-data-locations" title="Permalink to this heading">#</a></h3>
<p>This is a quick-and-dirty plot, so <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> is fine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span><span class="p">,</span> <span class="n">argo_med</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [deg E]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude [deg N]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Argo profile locations&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="fig-1-data-locations">
<h2>Fig 1. Data locations<a class="headerlink" href="#fig-1-data-locations" title="Permalink to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minlat</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">maxlat</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">minlon</span> <span class="o">=</span> <span class="mi">320</span>
<span class="n">maxlon</span> <span class="o">=</span> <span class="mi">340</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Draw a box on top of your figure to show where the selected region is.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">),</span> <span class="n">maxlon</span><span class="o">-</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlat</span><span class="o">-</span><span class="n">minlat</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Save the figure as Fig 1 for this exercise.  <code class="docutils literal notranslate"><span class="pre">ex5fig1-&lt;LastName&gt;-data_locations-seaocn.png</span></code></p></li>
</ul>
<p>We’ll work with data in an area with particularly high density of float profiles.</p>
<p>Choose a pressure surface to work with. Note that your pressure vector is 6 elements long.  Pick one depth to work with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define region</span>
<span class="n">minlat</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">maxlat</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">minlon</span> <span class="o">=</span> <span class="mi">320</span>
<span class="n">maxlon</span> <span class="o">=</span> <span class="mi">340</span>

<span class="c1"># Your code here</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span><span class="p">,</span> <span class="n">argo_med</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [deg E]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude [deg N]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Argo profile locations&#39;</span><span class="p">)</span>

<span class="c1"># Create a Rectangle patch &amp; add to plot</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">),</span> <span class="n">maxlon</span><span class="o">-</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlat</span><span class="o">-</span><span class="n">minlat</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

<span class="c1"># Save the figure to subdirectory figures/</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/ex5fig1-Example-data_locations-seaocn.png&quot;</span><span class="p">)</span>

<span class="c1"># Figure out how big the datasets are</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">argo_med</span><span class="p">[</span><span class="s1">&#39;tprof&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fig-2-clip-to-a-region-and-plot">
<h2>Fig 2. Clip to a region and plot<a class="headerlink" href="#fig-2-clip-to-a-region-and-plot" title="Permalink to this heading">#</a></h2>
<p>You’ve defined a maximum and minimum longitude and latitude above, and now you’d like to make your dataset smaller to work only within this region.</p>
<p><code class="docutils literal notranslate"><span class="pre">xarray</span></code> has a few options for finding/selecting/choosing subsets of a dataset.  These include <code class="docutils literal notranslate"><span class="pre">xr.sel()</span></code>, <code class="docutils literal notranslate"><span class="pre">xr.where()</span></code>, <code class="docutils literal notranslate"><span class="pre">xr.loc()</span></code>, etc.  They have some similarities and differences which we won’t go into here.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>If you do a google search for <code class="docutils literal notranslate"><span class="pre">subset</span> <span class="pre">xarray</span> <span class="pre">by</span> <span class="pre">lat</span> <span class="pre">lon</span> <span class="pre">region</span></code>, one of the options that shows up (as of 17 April 2024) is:
<a class="reference external" href="https://gis.stackexchange.com/questions/353698/how-to-clip-an-xarray-to-a-smaller-extent-given-the-lat-lon-coordinates">https://gis.stackexchange.com/questions/353698/how-to-clip-an-xarray-to-a-smaller-extent-given-the-lat-lon-coordinates</a></p>
<p>There are a few solutions offered by the community.  Try them and see which works.</p>
</div>
<p>One suggested method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mask_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span> <span class="o">&gt;=</span> <span class="n">minlon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span> <span class="o">&lt;=</span> <span class="n">maxlon</span><span class="p">)</span>
</pre></div>
</div>
<p>which creates a boolean vector which is True where <em>both</em> of these conditions are satisfied (the boolean operator <code class="docutils literal notranslate"><span class="pre">AND</span></code> or <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> requires both conditions to be satisfied.  The equivalent <code class="docutils literal notranslate"><span class="pre">OR</span></code> is <code class="docutils literal notranslate"><span class="pre">|</span></code>).  After creating this “mask”, the <code class="docutils literal notranslate"><span class="pre">xarray.DataSet.where()</span></code> function can be used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">argo_reg</span> <span class="o">=</span> <span class="n">argo_med</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_lon</span> <span class="o">&amp;</span> <span class="n">mask_lat</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The option <code class="docutils literal notranslate"><span class="pre">drop=True</span></code> says to drop the elements of the dataset that do not satisfy the conditions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This fails because our latitude and longitude vectors are &#39;variables&#39; and time is the only coordinate</span>
<span class="n">mask_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span> <span class="o">&gt;=</span> <span class="n">minlon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">argo_med</span><span class="o">.</span><span class="n">lond</span> <span class="o">&lt;=</span> <span class="n">maxlon</span><span class="p">)</span>
<span class="n">mask_lat</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">argo_reg</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1"># How large is the dataset now?</span>
<span class="nb">print</span><span class="p">(</span><span class="n">argo_reg</span><span class="p">)</span>

<span class="c1"># Your code here</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">lond</span><span class="p">,</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [deg E]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude [deg N]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Argo profile locations&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="c1"># Create a Rectangle patch</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">minlon</span><span class="p">,</span> <span class="n">minlat</span><span class="p">),</span> <span class="n">maxlon</span><span class="o">-</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlat</span><span class="o">-</span><span class="n">minlat</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># Add the patch to the Axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/ex5fig2-Example-data_locations-seaocn.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="remove-mean-any-obvious-latitudinal-dependence">
<h3>Remove mean &amp; any obvious latitudinal dependence<a class="headerlink" href="#remove-mean-any-obvious-latitudinal-dependence" title="Permalink to this heading">#</a></h3>
<p>Here you should plot against latitude and fit a polynomial (1 degree, if that suffices to remove most of the signal).  Note that a 1-degree polynomial will also remove the mean, so you don’t need to separately remove the mean of these values.  To check the mean of the dataset, use the <code class="docutils literal notranslate"><span class="pre">plt.hist()</span></code> command from <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
<p>Then check for a latitudinal dependence.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This figure does not need to be saved - it is a quick and dirty plot to take a look at the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="fig-3-compute-latitudinal-temperature-dependence">
<h2>Fig 3. Compute latitudinal temperature dependence<a class="headerlink" href="#fig-3-compute-latitudinal-temperature-dependence" title="Permalink to this heading">#</a></h2>
<p>Recall from <a class="reference internal" href="exercise-tseries.html"><span class="doc std std-doc">exercise 2a tseries</span></a> how to fit a 1-degree polynomial.</p>
<ol class="arabic">
<li><p>Extract data from one pressure level.  Note that the second dimension or axis of the <code class="docutils literal notranslate"><span class="pre">tprof</span></code> dataArray is not unit-length.  Pick one depth surface to use for the later exercises.  Call this vector <code class="docutils literal notranslate"><span class="pre">temp1</span></code> for consistency with later code examples.</p></li>
<li><p>Remove the NaN-values (if any).  For example, find the indices where there are NaN-values using <code class="docutils literal notranslate"><span class="pre">np.isnan</span></code>, then subselect only the good stuff from <code class="docutils literal notranslate"><span class="pre">temp1</span></code> using it in <code class="docutils literal notranslate"><span class="pre">temp1[~np.isnan(temp1)]</span></code>.  Remove these from latitude as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ikeep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span>
<span class="n">temp1</span> <span class="o">=</span> <span class="n">temp_anom</span><span class="p">[</span><span class="n">ikeep</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>Fit a 1-d polynomial to <code class="docutils literal notranslate"><span class="pre">temp1</span></code> as a function of <code class="docutils literal notranslate"><span class="pre">lat1</span></code> (latitude, with the same NaN-values removed).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minlat</span><span class="p">,</span><span class="n">maxlat</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">temp1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Remove the polynomial fit from the original data to create anomalies</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lat_model</span> <span class="o">=</span> <span class="n">p1</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
<span class="n">temp_anom</span><span class="p">[</span><span class="n">ikeep</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">-</span> <span class="n">lat_model</span>
</pre></div>
</div>
</li>
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> containing <code class="docutils literal notranslate"><span class="pre">temp_anom</span></code> then merge it using <code class="docutils literal notranslate"><span class="pre">xr.merge</span></code> back into <code class="docutils literal notranslate"><span class="pre">argo_reg</span></code>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a line</span>
<span class="n">lat1</span> <span class="o">=</span> <span class="n">argo_reg</span><span class="o">.</span><span class="n">latd</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># This is picking a specific depth.  What depth is it at?</span>
<span class="n">temp1</span> <span class="o">=</span> <span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Our new data vector will be called `temp_anom`</span>
<span class="n">temp_anom</span> <span class="o">=</span> <span class="n">temp1</span>
<span class="n">ikeep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span>

<span class="n">lat1</span> <span class="o">=</span> <span class="n">lat1</span><span class="p">[</span><span class="n">ikeep</span><span class="p">]</span>
<span class="n">temp1</span> <span class="o">=</span> <span class="n">temp1</span><span class="p">[</span><span class="n">ikeep</span><span class="p">]</span>

<span class="c1"># Fit a polynomial</span>
<span class="n">pf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># Calculate anomalies relative to the latitudinal gradient</span>
<span class="n">lat_model</span> <span class="o">=</span> <span class="n">p1</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
<span class="n">temp_anom</span><span class="p">[</span><span class="n">ikeep</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">-</span><span class="n">lat_model</span>

<span class="c1"># Merge these back into the original</span>
<span class="c1"># See what else needs to be used by checking the cell above</span>
<span class="n">data_xr4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;temp_anom&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="c1"># Merge into the same dataset</span>
<span class="n">argo_reg</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">argo_reg</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">argo_reg</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<section id="now-plot-the-process-of-fitting-a-line">
<h3>Now plot the process of fitting a line<a class="headerlink" href="#now-plot-the-process-of-fitting-a-line" title="Permalink to this heading">#</a></h3>
<p>And save as your 3rd figure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Determine latitude dependence</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">latd</span><span class="p">,</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">tprof</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">temp1</span><span class="p">,</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span><span class="n">p1</span><span class="p">(</span><span class="n">xp</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">temp_anom</span><span class="p">[</span><span class="n">ikeep</span><span class="p">],</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>

<span class="c1"># Annotate figure</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Latitude [deg N]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature anomaly [deg C]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature [deg C]&#39;</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/ex5fig3-Example-data_locations-seaocn.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optional-remove-outliers-larger-than-3-standard-deviations">
<h3>(Optional) Remove outliers larger than 3 standard deviations<a class="headerlink" href="#optional-remove-outliers-larger-than-3-standard-deviations" title="Permalink to this heading">#</a></h3>
<ol class="arabic">
<li><p>Compute the standard deviation of your data vector</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">temp_anom</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Create a mask for where these data are outliers (by a 3x std definition)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mask_outlier</span> <span class="o">=</span> <span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">temp_anom</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">std1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">argo_reg</span><span class="o">.</span><span class="n">temp_anom</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">std1</span><span class="p">)</span> 
</pre></div>
</div>
</li>
<li><p>Subselect the <code class="docutils literal notranslate"><span class="pre">argo_reg</span></code> for the non-outliers and save it into <code class="docutils literal notranslate"><span class="pre">argo_reg_good</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">argo_reg_good</span> <span class="o">=</span> <span class="n">argo_reg</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_outlier</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In case you don&#39;t do the optional, you still need the newly named `argo_reg_good` for later code.</span>
<span class="n">argo_reg_good</span> <span class="o">=</span> <span class="n">argo_reg</span>

<span class="c1"># Remove the outliers (optional)</span>
<span class="c1"># Uncomment and complete the lines</span>
<span class="c1">#std1 = ...</span>
<span class="c1">#mask_outlier = ...</span>
<span class="c1">#argo_reg_good = ...</span>


<span class="c1"># Print something to the screen to tell how many datapoints were removed (if any)</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">temp_anom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mq</span> <span class="o">=</span> <span class="n">argo_reg</span><span class="o">.</span><span class="n">temp_anom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mq</span><span class="o">-</span><span class="n">mp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; values out of a total of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mq</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">mq</span><span class="o">-</span><span class="n">mp</span><span class="p">)</span><span class="o">/</span><span class="n">mq</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f data points removed)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="computing-the-covariance-function">
<h2>Computing the covariance function<a class="headerlink" href="#computing-the-covariance-function" title="Permalink to this heading">#</a></h2>
<section id="calculate-pairwise-differences">
<h3>Calculate pairwise differences<a class="headerlink" href="#calculate-pairwise-differences" title="Permalink to this heading">#</a></h3>
<p>For every Argo measurement, calculate the difference to every other Argo measurement, and the difference in location (dx) and time (dt)</p>
<p>Read through the code below to understand what is going on.</p>
<ul>
<li><p>How are new vectors being initialised?  What is their initial size?  How does there size get increased in the loop?</p></li>
<li><p>What are the indices of the for-loops?  What values will <code class="docutils literal notranslate"><span class="pre">jj</span></code> (the outer loop index) take?  What about <code class="docutils literal notranslate"><span class="pre">ii</span></code>?   You can check this by adding some lines of code in relevant places within the loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
</pre></div>
</div>
<p>Make a <em>new cell</em> and try the very simple loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span>
</pre></div>
</div>
<p>What is the largest value of <code class="docutils literal notranslate"><span class="pre">jj</span></code>?  How does this compare to the inputs you put in <code class="docutils literal notranslate"><span class="pre">range()</span></code>?</p>
</li>
<li><p>What is the <code class="docutils literal notranslate"><span class="pre">theta</span></code> variable?  What are we using it for?</p></li>
<li><p>What is the factor <code class="docutils literal notranslate"><span class="pre">np.cos(theta...</span></code> doing?  Why is there an <code class="docutils literal notranslate"><span class="pre">np.pi/180</span></code> inside?</p></li>
<li><p>How big is <code class="docutils literal notranslate"><span class="pre">index</span></code> after executing the loop?  Note that this variable is only counting for you - it’s not doing anything else in this loop (but we will use it later).  How did we increment it?  What would happen if you changed the line to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>Did you notice the indentation used on the loops?  These are nested loops, so the activity inside the 2nd loop is indented twice.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New cell for your simple loop</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The size of the vectors will be ndat^2/2, so this gets pretty big</span>
<span class="n">ndat</span> <span class="o">=</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">temp_anom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Initialise some empty vectors</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">delt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">temp_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">myind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ndat</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ndat</span><span class="p">):</span> 
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">argo_reg_good</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">-</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">latd</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">-</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">latd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">lond</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">-</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">lond</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">argo_reg_good</span><span class="o">.</span><span class="n">latd</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">latd</span><span class="p">[</span><span class="n">kk</span><span class="p">]])</span>

        <span class="c1"># Distance</span>
        <span class="n">dist1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dlat</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dlon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">111</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dist1</span><span class="p">)</span>

        <span class="c1"># Time difference</span>
        <span class="n">delt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
        
        <span class="c1"># Temperature difference</span>
        <span class="n">dif_temp1</span> <span class="o">=</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">temp_anom</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">-</span> <span class="n">argo_reg_good</span><span class="o">.</span><span class="n">temp_anom</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span>
        <span class="n">temp_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_diff</span><span class="p">,</span> <span class="n">dif_temp1</span><span class="p">)</span>

        <span class="c1"># </span>
        <span class="n">myind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myind</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-new-xarray-to-hold-the-results">
<h3>Create a new <code class="docutils literal notranslate"><span class="pre">xarray</span></code> to hold the results<a class="headerlink" href="#create-a-new-xarray-to-hold-the-results" title="Permalink to this heading">#</a></h3>
<p>The data fields should include <code class="docutils literal notranslate"><span class="pre">time_diff</span></code>, <code class="docutils literal notranslate"><span class="pre">distance</span></code>, <code class="docutils literal notranslate"><span class="pre">temp_diff</span></code>, against the index <code class="docutils literal notranslate"><span class="pre">index</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an xarray</span>
<span class="n">data_xr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;time_diff&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">delt</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">myind</span><span class="p">},</span>
                       <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
<span class="n">data_xr2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dist</span><span class="p">,</span>
                        <span class="n">coords</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">myind</span><span class="p">},</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
<span class="n">data_xr3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;temp_diff&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">temp_diff</span><span class="p">,</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">myind</span><span class="p">},</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>

<span class="n">data_covar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_xr</span><span class="p">,</span> <span class="n">data_xr2</span><span class="p">,</span> <span class="n">data_xr3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_covar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="calculating-the-structure-function">
<h2>Calculating the structure function<a class="headerlink" href="#calculating-the-structure-function" title="Permalink to this heading">#</a></h2>
<div class="math notranslate nohighlight">
\[
&lt;(T_1-T_2)^2&gt; = &lt;T_1^2&gt; + &lt;T_2^2&gt; - 2&lt;T_1T_2&gt; = 2&lt;T^2&gt; + 2&lt;err^2&gt; - 2&lt;T_1T_2&gt;
\]</div>
<p>where <span class="math notranslate nohighlight">\(&lt;\cdot&gt;\)</span> denotes an average or mean.  The structure function <span class="math notranslate nohighlight">\(S\)</span> is the variance + squared error,</p>
<div class="math notranslate nohighlight">
\[
S = \frac{1}{2}&lt;(T_1-T_2)^2&gt;
\]</div>
<p>In python, this becomes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">delt_squared</span> <span class="o">=</span> <span class="n">data_covar</span><span class="o">.</span><span class="n">temp_diff</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>which is one half the squared temperature difference, but without the averaging in <span class="math notranslate nohighlight">\(S\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code here</span>
<span class="n">delt_squared</span> <span class="o">=</span> <span class="n">data_covar</span><span class="o">.</span><span class="n">temp_diff</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>

<span class="n">data_xr4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;deltsqr&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">delt_squared</span><span class="p">,</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">myind</span><span class="p">},</span>
                        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
<span class="n">data_covar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">data_covar</span><span class="p">,</span> <span class="n">data_xr4</span><span class="p">])</span>

<span class="n">nprs</span> <span class="o">=</span> <span class="n">delt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># We will bin the differences as a function of space and time</span>
<span class="c1"># Choose the width of each bin</span>
<span class="n">ds_bin</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># Spatial  - Use something like 10 - 100 kilometers (you can try a few)</span>

<span class="c1"># Choose a maximum distance to use</span>
<span class="n">maxd</span> <span class="o">=</span> <span class="mi">900</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Since the dataset is large, initially only work where the difference in time is small</span>
<span class="n">itime_small</span> <span class="o">=</span> <span class="n">delt</span><span class="o">&lt;</span><span class="n">dt_bin</span>
<span class="nb">len</span><span class="p">(</span><span class="n">itime_small</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">itime_small</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="bin-the-structure-function-as-a-function-of-distance">
<h3>Bin the structure function as a function of distance<a class="headerlink" href="#bin-the-structure-function-as-a-function-of-distance" title="Permalink to this heading">#</a></h3>
<p>Create the variable <span class="math notranslate nohighlight">\(S(x)\)</span> which is a binned estimate of the squared temperature differences, as a function of distance <span class="math notranslate nohighlight">\(x\)</span>.  We will call this <code class="docutils literal notranslate"><span class="pre">S_dx</span></code> in python, against the distance vector <code class="docutils literal notranslate"><span class="pre">ds</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask for nearby in time and in space</span>
<span class="c1"># There is no point in running this over the entire dataset since far away in space/time are unlikely to influence values at a point</span>
<span class="n">mask_small_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_covar</span><span class="o">.</span><span class="n">time_diff</span> <span class="o">&lt;</span> <span class="n">dt_bin</span><span class="p">)</span>
<span class="n">mask_small_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_covar</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">maxd</span><span class="p">)</span>
<span class="n">data_covar_near</span> <span class="o">=</span> <span class="n">data_covar</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_small_dt</span> <span class="o">&amp;</span> <span class="n">mask_small_ds</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Subset the distances and the other values for small time differences</span>

<span class="c1"># Length of vector for distances</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ds_bin</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxd</span><span class="p">,</span> <span class="n">ds_bin</span><span class="p">)</span>
<span class="c1"># Initialise the vector</span>
<span class="n">S_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Loop through the distance vector `ds`</span>
<span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)):</span>
    <span class="c1"># Create the lower and upper distance limits within which to compute the average</span>
    <span class="n">dsmall</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">ds_bin</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dlarge</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="n">ds_bin</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># Select for data within these limits</span>
    <span class="n">dt1</span> <span class="o">=</span> <span class="n">data_covar_near</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">distance</span> <span class="o">&gt;=</span> <span class="n">dsmall</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">dlarge</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calculate the average</span>
    <span class="n">smean1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dt1</span><span class="o">.</span><span class="n">deltsqr</span><span class="p">)</span>

    <span class="c1"># Append the value to the S_dx vector</span>
    <span class="n">S_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_dx</span><span class="p">,</span><span class="n">smean1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the binned structure function</span>

<span class="c1"># Variance /error increases with distance</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">S_dx</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$T_</span><span class="si">{rms}</span><span class="s1">^2$ [deg C^2]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="estimate-noise-and-variance">
<h3>Estimate noise and variance<a class="headerlink" href="#estimate-noise-and-variance" title="Permalink to this heading">#</a></h3>
<p>Where noise (errsq), signal variance (var_signal), total variance (var_total) are in the equation for the structure function as</p>
<div class="math notranslate nohighlight">
\[
2S = &lt;T1^2&gt; + &lt;T2^2&gt; -2&lt;T1*T2&gt; = 2&lt;T^2&gt; + 2&lt;err^2&gt; -2&lt;T1*T2&gt;
\]</div>
<p>for delt=0, this is the squared error.</p>
<p>for delt large, this is the total variance (signal variance plus the squared error).</p>
<p>You can repeat the above calculations changing the mask_small_dt values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Experiment with some values here that will affect your fit in the later code.</span>
<span class="n">errsqr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">var_total</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">var_signal</span> <span class="o">=</span> <span class="n">var_total</span> <span class="o">-</span> <span class="n">errsqr</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-a-covariance-function">
<h3>Fit a covariance function<a class="headerlink" href="#fit-a-covariance-function" title="Permalink to this heading">#</a></h3>
<p>The covariance function must be estimated either from the data to be mapped or from independent data. The function should be as simple as possible while still describing the essential variations in the data. Generally, an analytic function is used to allow for simple computation for a variety of spatial (and temporal) separations.  The covariance function should decrease with increasing distance (or time), which minimizes the possibility that (5) will produce unrealistic (e.g., negative) squared error estimates, another reason for removing periodic signals. Included in the covariance function is an estimate of the variance of the field, which may vary somewhat spatially. Finally, an estimate is needed of the random error in the measurements, in addition to the error associated with not having a measurement at the exact location (or time) of the grid points for the map.</p>
<p>Here we will use:</p>
<div class="math notranslate nohighlight">
\[
cov=var_{signal}*\exp(-ds^2/L_s^2-dt/L_t)
\]</div>
<p>In your calculations below, guess initial decorrelation length scale <span class="math notranslate nohighlight">\(L_s=300\)</span> km, and decorrelation time scale of 10 days, <span class="math notranslate nohighlight">\(L_t=10\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make some initial guesses for the decorrelation scales</span>
<span class="c1"># These are the distances in kilometers and days over which you expect data to be similar (or to have an influence on nearby datapoints in the map)</span>
<span class="n">Ls</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Lt</span> <span class="o">=</span> <span class="o">...</span>


<span class="c1"># Define a simple covariance function as a function of distance</span>
<span class="k">def</span> <span class="nf">my_covar_x</span><span class="p">(</span><span class="n">var_signal</span><span class="p">,</span><span class="n">ds</span><span class="p">,</span><span class="n">Ls</span><span class="p">):</span>
    <span class="n">covx</span> <span class="o">=</span> <span class="n">var_signal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">ds</span><span class="o">/</span><span class="n">Ls</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">covx</span>

<span class="c1"># Adjusting the value from the cell above to better fit the curve.</span>
<span class="n">var_sig2</span> <span class="o">=</span> <span class="mf">.9</span>

<span class="c1"># Covariance</span>
<span class="n">cov_ds</span> <span class="o">=</span> <span class="n">var_total</span> <span class="o">-</span> <span class="n">S_dx</span>

<span class="c1"># Calculate the decorrelation curve</span>
<span class="n">covx</span> <span class="o">=</span> <span class="n">my_covar_x</span><span class="p">(</span><span class="n">var_sig2</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">Ls</span><span class="p">)</span>

<span class="c1"># Plot it against the structure function</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">cov_ds</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">covx</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature covariance [(deg C)$^2$]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;For Ls = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Ls</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;km&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id2">
<h2>Bin the structure function as a function of distance<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<p>Repeat for distance, experimenting with values for <code class="docutils literal notranslate"><span class="pre">dt_bin</span></code> and <code class="docutils literal notranslate"><span class="pre">maxt</span></code>.  Note that there is no point in a very large <code class="docutils literal notranslate"><span class="pre">maxt</span></code> value since the dataset include data all collected within about 6 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mask for nearby in time and in space</span>
<span class="n">dt_bin</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># Temporal - Use something like 10 - 60 days (you can try a few)</span>
<span class="n">maxt</span> <span class="o">=</span> <span class="mi">150</span>

<span class="n">mask_small_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_covar</span><span class="o">.</span><span class="n">time_diff</span> <span class="o">&lt;</span> <span class="n">maxt</span><span class="p">)</span>
<span class="n">mask_small_ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_covar</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">ds_bin</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">data_covar_near</span> <span class="o">=</span> <span class="n">data_covar</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_small_dt</span> <span class="o">&amp;</span> <span class="n">mask_small_ds</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Subset the distances and the other values for small time differences</span>
<span class="c1"># Length of vector for distances</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dt_bin</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">dt_bin</span><span class="p">)</span>
<span class="n">S_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)):</span>
    <span class="n">dsmall</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">-</span><span class="n">dt_bin</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dlarge</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="n">dt_bin</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dt1</span> <span class="o">=</span> <span class="n">data_covar_near</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">time_diff</span> <span class="o">&gt;=</span> <span class="n">dsmall</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_covar_near</span><span class="o">.</span><span class="n">time_diff</span> <span class="o">&lt;</span> <span class="n">dlarge</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">smean1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dt1</span><span class="o">.</span><span class="n">strfcn</span><span class="p">)</span>
    <span class="n">S_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_dt</span><span class="p">,</span><span class="n">smean1</span><span class="p">)</span>

<span class="c1"># Plot the binned structure function</span>
<span class="c1"># Variance /error increases with distance</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">S_dt</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time differential [days]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$T_</span><span class="si">{rms}</span><span class="s1">^2$ [deg C^2]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Fit a covariance function</span>
<span class="n">Ls</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Lt</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">cov_dt</span> <span class="o">=</span> <span class="n">var_total</span> <span class="o">-</span> <span class="n">S_dt</span>

<span class="c1"># Simple covariance in time</span>
<span class="k">def</span> <span class="nf">my_covar_t</span><span class="p">(</span><span class="n">var_signal</span><span class="p">,</span><span class="n">ds</span><span class="p">,</span><span class="n">Ls</span><span class="p">):</span>
    <span class="n">covt</span> <span class="o">=</span> <span class="n">var_signal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dt</span><span class="o">/</span><span class="n">Lt</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">covt</span>

<span class="n">covt</span> <span class="o">=</span> <span class="n">my_covar_t</span><span class="p">(</span><span class="n">var_sig2</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Lt</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">cov_dt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">covt</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time differential [days]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature covariance [(deg C)$^2$]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;For Lt = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Lt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;days&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combined time and space decorrelation</span>
<span class="k">def</span> <span class="nf">my_covar_xt</span><span class="p">(</span><span class="n">var_signal</span><span class="p">,</span><span class="n">ds</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">Lt</span><span class="p">):</span>
    <span class="n">covxt</span> <span class="o">=</span> <span class="n">var_signal</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">ds</span><span class="o">/</span><span class="n">Ls</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dt</span><span class="o">/</span><span class="n">Lt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">covxt</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="optimal-interpolation">
<h1>Optimal interpolation<a class="headerlink" href="#optimal-interpolation" title="Permalink to this heading">#</a></h1>
<p>Optimal interpolation (or “objective mapping,” as it is frequently called in oceanography, or “kriging” in geophysics) is a procedure for obtaining a map from observations that has the minimum squared error, based on the statistics of the field to be mapped <span id="id3">Bretherton <em>et al.</em> [<a class="reference internal" href="../resource/books.html#id5" title="F. P. Bretherton, R. E. Davis, and C. B. Fandry. A technique for objective analysis and design of oceanographic experiments applied to MODE-73. Deep-Sea Res., 23:559–582, 1976.">1976</a>]</span>. The unique aspect of this procedure is the error map that accompanies the map of the desired variable.</p>
<p>Why compute an objective map?</p>
<ul class="simple">
<li><p>to get a gridded field from irregularly spaced data (for data assimilation or for forcing a model)</p></li>
<li><p>to get a field with which to derive other estimates (e.g., geostrophic velocity from fields of density)</p></li>
<li><p>to get an estimate of the errors associated with a set of measurements at various locations and times</p></li>
</ul>
<section id="deriving-the-objective-estimate">
<h2>Deriving the objective estimate<a class="headerlink" href="#deriving-the-objective-estimate" title="Permalink to this heading">#</a></h2>
<p>Given a set of measurements at arbitrary locations (and times), <span class="math notranslate nohighlight">\(D(x,y,t)\)</span>, we want to create a series of maps at regular locations (and times).  The measurement locations may be fixed, as in measurements from moored instruments, random as from Argo floats, or repeating but not on a uniform grid, as for satellite observations. The problem is to find the best linear combination of observed values for an estimate at a fixed location and time</p>
<div class="math notranslate nohighlight">
\[
\hat{d}(x_0,y_0,t_0) = D\alpha\qquad\qquad (1)
\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> is a vector of coefficients that are applied to the matrix of observations <span class="math notranslate nohighlight">\(D\)</span>.  The columns of <span class="math notranslate nohighlight">\(D\)</span> are time series at the various location <span class="math notranslate nohighlight">\((x,y)\)</span>. The best estimate is one that minimizes the square of the error</p>
<div class="math notranslate nohighlight">
\[
\epsilon = \hat{d}(x_0,y_0,t_0)-d_T(x_0,y_0,t_0)\qquad\qquad (2)
\]</div>
<p>where <span class="math notranslate nohighlight">\(d_T\)</span> is the actual value of the variable at that location and time.</p>
<p>To insure the smallest squared error, we require that the error be orthogonal to the estimate, that is,</p>
<p>This statement requires some interpretation, because it assumes that we have a time series (or an ensemble) of estimates of the variable and therefore an ensemble of errors, with which to determine <span class="math notranslate nohighlight">\(\alpha\)</span>. For simplicity, take a hypothetical case in which data comes from fixed locations (as from a mooring) with no gaps (imagine!). Then at any given location the coefficients <span class="math notranslate nohighlight">\(\alpha\)</span> will not change in time and we have the times series for (2). Combining (1) and (2) gives</p>
<div class="math notranslate nohighlight">
\[
(D\alpha)^T(D\alpha-d_T)=0
\]</div>
<p>or</p>
<div class="math notranslate nohighlight">
\[
\alpha^T D^T D\alpha = \alpha^T D^T d_T
\]</div>
<p>where <span class="math notranslate nohighlight">\(C\)</span> is the data-data covariance matrix, then</p>
<div class="math notranslate nohighlight">
\[
\alpha^T C\alpha = \alpha^T z \qquad\qquad (3)
\]</div>
<p>and <span class="math notranslate nohighlight">\(N\)</span> is the length of the time series in <span class="math notranslate nohighlight">\(D\)</span>, so that</p>
<div class="math notranslate nohighlight">
\[
\frac{D^TD}{N} = C
\]</div>
<p>that is, the covariance between all the observations (at each of the moorings) with each other and <span class="math notranslate nohighlight">\(z\)</span> is a vector of covariances between the observations and the actual value <span class="math notranslate nohighlight">\(d_T\)</span>, as</p>
<div class="math notranslate nohighlight">
\[
z = \frac{D^Td_T}{N}
\]</div>
<p>We can solve for the coefficients <span class="math notranslate nohighlight">\(\alpha\)</span> explicitly as</p>
<div class="math notranslate nohighlight">
\[
\alpha = C^{-1}z \qquad\qquad (4)
\]</div>
<p>For the actual calculation in python, we use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">zz</span><span class="p">)</span>
</pre></div>
</div>
<p>It seems reasonable to estimate <span class="math notranslate nohighlight">\(C\)</span> from the observations (at least for the mooring example), but how do we get <span class="math notranslate nohighlight">\(z\)</span> when we do not know the actual value of the variable? In practice, we approximate the covariances using a simple (analytic) function.   For a spatial map, the covariance function may simply be a function of the distance between the data locations, or it might vary in the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>-directions, if their statistics differ significantly. In addition to the spatial separation, it might include the temporal separation. So, the covariance matrix <span class="math notranslate nohighlight">\(C\)</span> between data at different locations is just a function of their separation. Similarly, the covariance matrix <span class="math notranslate nohighlight">\(z\)</span> is just a function of the distance between the observations (here, the moorings) and the grid point in the map.</p>
<p>To understand the form of the coefficients (4), note that the “numerator” <span class="math notranslate nohighlight">\(z\)</span> depends on how close the data are to the grid point <span class="math notranslate nohighlight">\((x_0,y_0)\)</span>, that is, the data that are nearest to the grid point are weighted most heavily in the estimate (1). What about the denominator <span class="math notranslate nohighlight">\(C\)</span>?  The data covariance matrix describes how well the data are correlated with each other, that is, the extent to which observations that are close to each other are redundant or, conversely, that widely separated observations are independent.  The denominator can be seen as a correction to the weighting by distance from the grid point (the numerator) to account for data redundancy.</p>
</section>
<section id="the-error-estimate">
<h2>The error estimate<a class="headerlink" href="#the-error-estimate" title="Permalink to this heading">#</a></h2>
<p>What is the (squared) error associated with this estimate?</p>
<div class="math notranslate nohighlight">
\[
\epsilon^T\epsilon = \left(\hat{d}-d_T\right)^T\left(\hat{d}-d_T\right)
= \hat{d}^T\hat{d} - 2\hat{d}^Td_T + d_T^Td_T
\]</div>
<p>Using (1) and (3) we can combine the first and second terms (on the right) to get</p>
<div class="math notranslate nohighlight">
\[
\epsilon^T\epsilon = d_T^T d_T-  \hat{d}^Td_T = d_T^Td_T - \alpha^TD^Td_T
\]</div>
<p>where the first term is the <em>data variance</em> (times <span class="math notranslate nohighlight">\(N\)</span>) and the second term can be simplified using (4) to get</p>
<div class="math notranslate nohighlight">
\[
\left&lt;\epsilon^2\right&gt;=\sigma_d^2-\alpha^Tz \qquad\qquad (5)
\]</div>
<p>where the first term on the RHS is the data variance. For observations that are poorly correlated with the location of a grid point in the map, the squared error can approach the variance. In this case, the estimate is not useful.</p>
</section>
<section id="removing-the-mean-and-periodic-signals">
<h2>Removing the mean and periodic signals<a class="headerlink" href="#removing-the-mean-and-periodic-signals" title="Permalink to this heading">#</a></h2>
<p>The objective map is performed on random variables whose statistics can be described by a covariance function. Generally, if the data is a function of time <span class="math notranslate nohighlight">\(d(x,t)\)</span>, the temporal mean is removed, because of its implicit association with the ensemble average. By removing the mean and mapping the anomaly, the mapping program will not have to try to recover the mean value using sparse data. If the expected squared error is large, the anomaly can then be set to zero. A similar argument can be made for a periodic signal, if it is reasonably well-defined either by climatology or a long data record. The mapped anomaly can be added to the mean (and periodic signal) to recover the total value of the variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">obj_map_2D</span><span class="p">(</span><span class="n">vart</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">smax</span><span class="p">,</span> <span class="n">Ls</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">Lt</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">longrid</span><span class="p">,</span> <span class="n">latgrid</span><span class="p">,</span> <span class="n">tmap</span><span class="p">):</span>
    <span class="c1"># 2D objective map using data(lon,lat,time)</span>
    <span class="c1">#</span>
    <span class="c1"># Note: temporal mean of data should be removed first</span>
    <span class="c1"># compute 2D Gauss-Markov (objective) estimate </span>
    <span class="c1">#</span>
    <span class="c1"># data - xarray of location, time, and observed value</span>
    <span class="c1">#	 variables lond, latd, time and temp_anom</span>
    <span class="c1"># longrid, latgrid - output locations for maps</span>
    <span class="c1"># tmap - time of output map - in Matlab time, float since 0000-01-01 with</span>
    <span class="c1"># increment of days, i.e. 0000-01-02 is 1.</span>
    <span class="c1">#</span>
    <span class="c1"># data variance (vart) is given by</span>
    <span class="c1">#  vart = var + noise^2</span>
    <span class="c1">#</span>
    <span class="c1"># error is in units of signal (NOT fractional)</span>
    <span class="c1">#</span>
    <span class="c1"># For each output grid point:</span>
    <span class="c1">#	1) find data within within smax and tmax of grid pt &amp; tmap </span>
    <span class="c1">#	2) compute data-data covariance matrix </span>
    <span class="c1">#	3) compute data-xgrid covariance vector zz				</span>
    <span class="c1">#	4) compute the coefficients </span>
    <span class="c1">#		alpha = inv(C) * zz      (alpha=C\zz)</span>
    <span class="c1">#	5) compute the estimate for each grid point</span>
    <span class="c1">#		dhat=dij*alpha</span>
    <span class="c1">#	6) compute the normalized error estimate</span>
    <span class="c1">#		err^2 = var - zz&#39;*alpha </span>
    <span class="c1">#	7) check for instabilities in error calculation &amp; replace with closest </span>
    <span class="c1">#      single datum, if necessary</span>
    <span class="c1">#</span>
    <span class="p">[</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">]</span> <span class="o">=</span> <span class="n">longrid</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Unpack the input data</span>
    <span class="n">lon_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">lond</span>
    <span class="n">lat_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">latd</span>
    <span class="n">time_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span> <span class="c1"># Note these are in Matlab datenum format (days since 0000-01-01)</span>
    <span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">temp_anom</span>

    <span class="n">err0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vart</span><span class="p">);</span>

    <span class="c1"># Initialise the mapped data &amp; error</span>
    <span class="n">mapdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
    <span class="n">err_rms</span> <span class="o">=</span> <span class="n">err0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mapdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Conversions for lat to kilometers</span>
    <span class="n">yscl</span> <span class="o">=</span> <span class="mi">111</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lat_data</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>

    <span class="c1"># Cycle through positions in the grid</span>
    <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="p">):</span>
        
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">):</span>
            <span class="c1"># Find distance (km) from data to the map grid point at</span>
            <span class="c1"># latgrid[jj,ii] and longrid[jj,ii]</span>
            <span class="c1"># Note: data_lon and data_lat are vectors of the same length</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="n">yscl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_data</span> <span class="o">-</span> <span class="n">longrid</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat_data</span> <span class="o">-</span> <span class="n">latgrid</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Find the time difference between the time for the map (tmap) and of the data (time_data)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time_data</span> <span class="o">-</span> <span class="n">tmap</span><span class="p">)</span>
    
            <span class="c1"># Boolean mask for distances &lt; smax and time diff &lt; tmax</span>
            <span class="n">mask_near</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr</span> <span class="o">&lt;</span> <span class="n">smax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">)</span>

            <span class="c1"># How many data points are near enough to be used?</span>
            <span class="n">npt</span> <span class="o">=</span> <span class="n">mask_near</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># If there are any original datapoints nearby in time/space, then continue</span>
            <span class="k">if</span> <span class="n">npt</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Subselect the input data for only those points near in time/space</span>
                <span class="n">lat_near_ij</span> <span class="o">=</span> <span class="n">lat_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">lon_near_ij</span> <span class="o">=</span> <span class="n">lon_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">time_near_ij</span> <span class="o">=</span> <span class="n">time_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">val_near_ij</span> <span class="o">=</span> <span class="n">val_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">dr_near_ij</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">dt_near_ij</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_near</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

                <span class="c1"># Compute data-grid covariance vector</span>
                <span class="n">zz</span> <span class="o">=</span> <span class="n">my_covar_xt</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">dr_near_ij</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="n">dt_near_ij</span><span class="p">,</span><span class="n">Lt</span><span class="p">)</span>
                
                <span class="c1"># Compute data-data covariance matrix</span>
                <span class="c1"># Initialise an empty matrix, sized npt x npt square matrix</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">npt</span><span class="p">,</span><span class="n">npt</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">iii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npt</span><span class="p">):</span>
                    <span class="n">lat_data1</span> <span class="o">=</span> <span class="n">lat_near_ij</span><span class="p">[</span><span class="n">iii</span><span class="p">]</span>
                    <span class="n">lon_data1</span> <span class="o">=</span> <span class="n">lon_near_ij</span><span class="p">[</span><span class="n">iii</span><span class="p">]</span>
                    <span class="n">time_data1</span> <span class="o">=</span> <span class="n">time_near_ij</span><span class="p">[</span><span class="n">iii</span><span class="p">]</span>
                    
                    <span class="k">for</span> <span class="n">jjj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npt</span><span class="p">):</span>
                        <span class="n">lat_data2</span> <span class="o">=</span> <span class="n">lat_near_ij</span><span class="p">[</span><span class="n">jjj</span><span class="p">]</span>
                        <span class="n">lon_data2</span> <span class="o">=</span> <span class="n">lon_near_ij</span><span class="p">[</span><span class="n">jjj</span><span class="p">]</span>
                        <span class="n">time_data2</span> <span class="o">=</span> <span class="n">time_near_ij</span><span class="p">[</span><span class="n">jjj</span><span class="p">]</span>

                        <span class="c1"># Compute distance between pairs of data points</span>
                        <span class="n">dr_data</span> <span class="o">=</span> <span class="n">yscl</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_data2</span> <span class="o">-</span> <span class="n">lon_data1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">lat_data2</span> <span class="o">-</span> <span class="n">lat_data1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                        <span class="c1"># Compute delta time between the data points</span>
                        <span class="n">dt_data</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time_data2</span> <span class="o">-</span> <span class="n">time_data1</span><span class="p">)</span>

                        <span class="c1"># Covariance matrix</span>
                        <span class="n">C</span><span class="p">[</span><span class="n">iii</span><span class="p">,</span><span class="n">jjj</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_covar_xt</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">dr_data</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="n">dt_data</span><span class="p">,</span><span class="n">Lt</span><span class="p">)</span>
    
                <span class="c1"># Compute map value and error estimate</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">zz</span><span class="p">)</span>
    
                <span class="c1"># Map the data values into the map locations</span>
                <span class="n">dhat</span> <span class="o">=</span> <span class="n">val_near_ij</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">@</span> <span class="n">alpha</span>
                <span class="c1"># Estimate the error</span>
                <span class="n">ersqs</span> <span class="o">=</span> <span class="n">vart</span> <span class="o">-</span> <span class="n">zz</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">@</span> <span class="n">alpha</span>
    
                <span class="c1"># Value &amp; error at nearest point (max covariance)</span>
                <span class="n">zz0</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                <span class="n">err1</span> <span class="o">=</span> <span class="n">vart</span> <span class="o">-</span> <span class="n">zz0</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">var</span>
    
                <span class="c1"># Check for instability:</span>
                <span class="c1"># 1) estimated error &gt; error for single nearest point, or</span>
                <span class="c1"># 2) squared error &lt; 0</span>
                <span class="c1"># For one datum: alpha = zz0/var</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ersqs</span> <span class="o">&gt;</span> <span class="n">err1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ersqs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">dij</span> <span class="o">=</span> <span class="n">dij</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="c1"># at max zz</span>
                    <span class="n">ersqs</span> <span class="o">=</span> <span class="n">err1</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">zz0</span><span class="o">/</span><span class="n">var</span>
                    <span class="n">dhat</span> <span class="o">=</span> <span class="n">val_near_ij</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">@</span> <span class="n">alpha</span>

                <span class="c1"># Map values</span>
                <span class="n">mapdata</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dhat</span>
                <span class="n">err_rms</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ersqs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapdata</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">err_rms</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">mapdata</span><span class="p">,</span> <span class="n">err_rms</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-the-optimal-interpolation">
<h2>Run the optimal interpolation<a class="headerlink" href="#run-the-optimal-interpolation" title="Permalink to this heading">#</a></h2>
<p>Loop through time (months).</p>
<p>Add comments to the code below to describe what each section or line is doing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## run obj map routine </span>
<span class="c1"># map 1 month at a time</span>
<span class="c1"># Define the maximum space/time intervals over which to grid</span>
<span class="n">smax</span> <span class="o">=</span> <span class="mf">.7</span><span class="o">*</span><span class="n">Ls</span>
<span class="n">tmax</span> <span class="o">=</span> <span class="mf">.7</span><span class="o">*</span><span class="n">Lt</span>

<span class="c1"># Define a map grid</span>
<span class="n">latg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minlat</span><span class="p">,</span> <span class="n">maxlat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="p">[</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">long</span><span class="p">,</span><span class="n">latg</span><span class="p">)</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">my_covar_xt</span><span class="p">(</span><span class="n">var_signal</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Lt</span><span class="p">)</span>     <span class="c1"># max space lag, no time lag</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">my_covar_xt</span><span class="p">(</span><span class="n">var_signal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">Lt</span><span class="p">)</span>     <span class="c1"># max time lag, no space lag</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">argo_reg_good</span>

<span class="n">epoch0</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;0000-01-01&#39;</span><span class="p">))</span>
<span class="n">epoch1</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="n">vart</span> <span class="o">=</span> <span class="n">var_total</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">var_signal</span>

<span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">xgrid</span><span class="o">.</span><span class="n">shape</span>
<span class="n">nt</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">mapT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">nt</span><span class="p">))</span>
<span class="n">errT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">nt</span><span class="p">))</span>

<span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;2003-0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mm</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-15&#39;</span><span class="p">))</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">time1</span> <span class="o">+</span> <span class="n">epoch1</span> <span class="o">-</span> <span class="n">epoch0</span>
    <span class="c1"># call obj_map_2D</span>
    <span class="n">mapdata</span><span class="p">,</span> <span class="n">err_rms</span> <span class="o">=</span> <span class="n">obj_map_2D</span><span class="p">(</span><span class="n">vart</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">Ls</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">Lt</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">xgrid</span><span class="p">,</span><span class="n">ygrid</span><span class="p">,</span><span class="n">time2</span><span class="p">);</span>
    <span class="n">mapT</span><span class="p">[:,:,</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapdata</span><span class="p">;</span>
    <span class="n">errT</span><span class="p">[:,:,</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_rms</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fig-4-plot-the-mapped-data">
<h2>Fig 4. Plot the mapped data<a class="headerlink" href="#fig-4-plot-the-mapped-data" title="Permalink to this heading">#</a></h2>
<p>For one of the depth surfaces, plot the mapped data and error estimate.  Basic code is below.  Update for a better projection (e.g. Mercator).</p>
<p>Be sure to annotate your figure with the choice of <span class="math notranslate nohighlight">\(L_s\)</span>, <span class="math notranslate nohighlight">\(L_t\)</span> and the depth/pressure surface that you are mapping.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot an example of the mapped data.</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span><span class="n">ygrid</span><span class="p">,</span><span class="n">mapT</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [$^\circ$E]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude [$^\circ$N]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ls = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Ls</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;km, Lt = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Lt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span><span class="n">ygrid</span><span class="p">,</span><span class="n">errT</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [$^\circ$E]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude [$^\circ$N]&#39;</span><span class="p">)</span>


<span class="c1"># Add the original Argo data over</span>

<span class="c1"># Fix the colorbar.  Try to load something from https://colorbrewer2.org/#type=sequential&amp;scheme=BuGn&amp;n=3</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fig-5-add-back-in-your-mean-and-latitudinal-dependence-plot">
<h2>Fig 5. Add back in your mean and latitudinal dependence + plot<a class="headerlink" href="#fig-5-add-back-in-your-mean-and-latitudinal-dependence-plot" title="Permalink to this heading">#</a></h2>
<p>Note that for the mapped data, you need to do this using your <code class="docutils literal notranslate"><span class="pre">xgrid</span></code> or <code class="docutils literal notranslate"><span class="pre">ygrid</span></code> and with the polynomial fit you identified above.</p>
<p>Plot the mapped data and save as Fig 5.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-root-py"
        },
        kernelOptions: {
            name: "conda-root-py",
            path: "./exercise"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-root-py'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="exercise-geostrophy.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Exercise 4 -  Slopes &amp; Integrals</p>
      </div>
    </a>
    <a class="right-next"
       href="exercise-ctd-align.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Exercise 6 - CTD Alignment</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Exercise 5 (demo) - Optimal interpolation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data">Explore the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-notebook">Create a notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-matlab-data">Load Matlab data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#convert-data-to-xarray">Convert data to <code class="docutils literal notranslate"><span class="pre">xarray</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-missingdimensionserror">Error: <code class="docutils literal notranslate"><span class="pre">MissingDimensionsError</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-data-locations">Plot data locations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1-data-locations">Fig 1. Data locations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-2-clip-to-a-region-and-plot">Fig 2. Clip to a region and plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-mean-any-obvious-latitudinal-dependence">Remove mean &amp; any obvious latitudinal dependence</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-3-compute-latitudinal-temperature-dependence">Fig 3. Compute latitudinal temperature dependence</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-plot-the-process-of-fitting-a-line">Now plot the process of fitting a line</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-remove-outliers-larger-than-3-standard-deviations">(Optional) Remove outliers larger than 3 standard deviations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-the-covariance-function">Computing the covariance function</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-pairwise-differences">Calculate pairwise differences</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-new-xarray-to-hold-the-results">Create a new <code class="docutils literal notranslate"><span class="pre">xarray</span></code> to hold the results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-the-structure-function">Calculating the structure function</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bin-the-structure-function-as-a-function-of-distance">Bin the structure function as a function of distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-noise-and-variance">Estimate noise and variance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-covariance-function">Fit a covariance function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Bin the structure function as a function of distance</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimal-interpolation">Optimal interpolation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deriving-the-objective-estimate">Deriving the objective estimate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-error-estimate">The error estimate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-the-mean-and-periodic-signals">Removing the mean and periodic signals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-the-optimal-interpolation">Run the optimal interpolation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-4-plot-the-mapped-data">Fig 4. Plot the mapped data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-5-add-back-in-your-mean-and-latitudinal-dependence-plot">Fig 5. Add back in your mean and latitudinal dependence + plot</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Eleanor Frajka-Williams
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>